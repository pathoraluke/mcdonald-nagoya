<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>3D円柱グラフ＋愛知県境界 (自前アニメーション)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css"
        rel="stylesheet"/>
  <style>
    html,body,#map{ height:100%;margin:0;padding:0;background:#fff }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/deck.gl@8.9.4/dist.min.js"></script>
  <script src="https://unpkg.com/@deck.gl/mapbox@8.9.4/dist.min.js"></script>
  <script src="data.js"></script>
  <script>
    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://demotiles.maplibre.org/style.json',
      center: [136.9066,35.1815],
      zoom:11,pitch:50,bearing:-20,
      attributionControl:false
    });

    map.on('load', () => {
      const boundary = new deck.GeoJsonLayer({
        id: 'aichi-boundary',
        data: 'Aichi.geojson',
        stroked: true, filled: false,
        lineWidthMinPixels:2,
        getLineColor:[50,50,50,200]
      });

      // ここでは高さゼロでインスタンス化
      const cyl = new deck.ColumnLayer({
        id: 'cylinders',
        data, diskResolution:12, radius:200,
        extruded:true, pickable:true,
        getPosition:d=>[d.lon,d.lat],
        getElevation:_=>0,            // 初期0
        getFillColor:[255,0,0,200]
      });

      const overlay = new deck.MapboxOverlay({ layers:[boundary, cyl] });
      map.addControl(overlay);

      // アニメーションループ
      const DURATION = 1000;       // 1秒
      const start    = performance.now();

      function frame(now) {
        const t = Math.min((now - start) / DURATION, 1);

        // フレームごとに高さを少しずつ更新
        cyl.props.getElevation = d => d.count * 1000 * t;

        // レイヤーを差し替え
        overlay.setProps({ layers: [boundary, cyl] });

        // 地図を再描画
        map.triggerRepaint();

        // t<1 の間ループ
        if (t < 1) {
          requestAnimationFrame(frame);
        }
      }

      // 少し遅らせて開始すると見栄えUP
      setTimeout(() => requestAnimationFrame(frame), 200);
    });
  </script>
</body>
</html>
