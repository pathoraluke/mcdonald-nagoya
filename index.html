<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>3D 円柱ニョキニョキ (deck.gl + MapLibre)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- ① MapLibre GL CSS（これがないと地図タイルが見えません） -->
  <link
    href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css"
    rel="stylesheet"
  />

  <style>
    html, body, #map {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #fff;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- ② MapLibre GL JS -->
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <!-- deck.gl は Mapbox Adapter 名義で MapLibre を参照します -->
  <script>window.mapboxgl = maplibregl;</script>
  <!-- ③ deck.gl 本体 -->
  <script src="https://unpkg.com/deck.gl@8.9.4/dist.min.js"></script>
  <!-- ④ あなたのデータ -->
  <script src="data.js"></script>

  <script>
    // ─── １．DeckGL 初期化 ────────────────────────────
    const deckgl = new deck.Deck({
      container: 'map',
      mapStyle: 'https://demotiles.maplibre.org/style.json',
      initialViewState: {
        longitude: 136.9066,
        latitude:  35.1815,
        zoom:      11,
        pitch:     50,
        bearing:  -20
      },
      controller: true,
      layers: [
        // 境界
        new deck.GeoJsonLayer({
          id: 'aichi-boundary',
          data: 'Aichi.geojson',
          stroked: true,
          filled: false,
          lineWidthMinPixels: 2,
          getLineColor: [50, 50, 50, 200]
        }),
        // 初期高さ0の円柱
        new deck.ColumnLayer({
          id: 'cylinders',
          data,
          diskResolution: 12,
          radius: 200,
          extruded: true,
          pickable: true,
          getPosition: d => [d.lon, d.lat],
          getElevation: () => 0,
          getFillColor: [255, 0, 0, 200],
          transitions: {
            getElevation: { duration: 1000 }
          }
        })
      ]
    });

    // ─── ２．少し待ってから「高さ」を差し替えてニョキニョキ動かす ─────────
    setTimeout(() => {
      deckgl.setProps({
        layers: deckgl.props.layers.map(layer => {
          if (layer.id === 'cylinders') {
            return layer.clone({
              getElevation: d => d.count * 1000
            });
          }
          return layer;
        })
      });
    }, 300);
  </script>
</body>
</html>
