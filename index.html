<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>3D 円柱ニョキニョキ (deck.gl + MapLibre)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- ① MapLibre GL の CSS（★これが必須） -->
  <link
    href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css"
    rel="stylesheet"
  />

  <style>
    html, body, #map {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #fff;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- ② MapLibre GL JS -->
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>

  <!-- ③ deck.gl は mapboxgl エイリアスを必要とするので -->
  <script>window.mapboxgl = maplibregl;</script>

  <!-- ④ deck.gl 本体 -->
  <script src="https://unpkg.com/deck.gl@8.9.4/dist.min.js"></script>

  <!-- ⑤ データ -->
  <script src="data.js"></script>

  <script>
    // １．deck.Deck を初期化
    const deckgl = new deck.Deck({
      container: 'map',
      // mapStyle に maplibre のデフォルトを渡せば自動で背景地図を読み込みます
      mapStyle: 'https://demotiles.maplibre.org/style.json',
      initialViewState: {
        longitude: 136.9066,
        latitude:  35.1815,
        zoom:      11,
        pitch:     50,
        bearing:  -20
      },
      controller: true,
      layers: [
        // ■県境
        new deck.GeoJsonLayer({
          id: 'aichi-boundary',
          data: 'Aichi.geojson',      // ★大文字・小文字を要確認！
          stroked: true,
          filled: false,
          lineWidthMinPixels: 2,
          getLineColor: [50, 50, 50, 200]
        }),
        // ■円柱（初期高さ 0）
        new deck.ColumnLayer({
          id: 'cylinders',
          data,                       // data.js で定義したグローバル変数
          diskResolution: 12,
          radius: 200,
          extruded: true,
          pickable: true,
          getPosition: d => [d.lon, d.lat],
          getElevation: () => 0,      // 初回は高さ０
          getFillColor: [255, 0, 0, 200],
          transitions: {
            getElevation: { duration: 1000 }
          }
        })
      ]
    });

    // ２．少し待ってから高さを更新してニョキニョキアニメ
    setTimeout(() => {
      deckgl.setProps({
        layers: deckgl.props.layers.map(layer => {
          if (layer.id === 'cylinders') {
            return layer.clone({
              getElevation: d => d.count * 1000  // 件数×1km
            });
          }
          return layer;
        })
      });
    }, 300);
  </script>
</body>
</html>
